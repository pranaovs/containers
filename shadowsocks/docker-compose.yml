services:
  shadowsocks:
    image: quay.io/outline/shadowbox:stable
    container_name: shadowsocks
    restart: always
    ports:
      - "30042:80/tcp" # Management API
      - "443:443/udp" # Access key port (UDP)
      # - "${SB_KEYS_PORT}:${SB_KEYS_PORT}/tcp"   # Access key port (TCP)
    environment:
      - SB_API_PORT=80
      - SB_STATE_DIR=/data
      - SB_API_PREFIX=${SB_API_PREFIX}
      - SB_CERTIFICATE_FILE=/data/shadowbox-selfsigned.crt
      - SB_PRIVATE_KEY_FILE=/data/shadowbox-selfsigned.key
    volumes:
      - ./data:/data:Z,U
    expose:
      - "9091"
    labels:
      # Traefik
      - "traefik.enable=true"
      - "traefik.tcp.routers.shadowsocks.rule=HostSNI(`*`)"
      - "traefik.tcp.routers.shadowsocks.entrypoints=websecure"
      - "traefik.tcp.services.shadowsocks.loadbalancer.server.port=443"
      - "traefik.tcp.routers.shadowsocks.priority=1" # Lowest priority
      - "traefik.docker.network=traefik_net"
      # Watchtower
      - "com.centurylinklabs.watchtower.enable=true"
      # Podman Auto-Update
      - "io.containers.autoupdate=registry"
    networks:
      - traefik_net

  autokuma:
    image: busybox:latest
    container_name: shadowsocks-autokuma
    restart: always
    command: ["sleep", "infinity"]
    healthcheck:
      test: ["CMD", "sleep", "0"]
    labels:
      # AutoKuma (uptime-kuma)
      - "kuma.shadowsocks_grp.group.name=Shadowsocks"
      - 'kuma.shadowsocks_grp.group.notification_name_list=["ntfy"]'
      - "kuma.shadowsocks_container.docker.name=Shadowsocks Container"
      - "kuma.shadowsocks_container.docker.docker_container=shadowsocks"
      - "kuma.shadowsocks_container.docker.docker_host_name=local"
      - "kuma.shadowsocks_container.docker.parent_name=shadowsocks_grp"
      # Watchtower
      - "com.centurylinklabs.watchtower.enable=true"
      # Podman Auto-Update
      - "io.containers.autoupdate=registry"

networks:
  traefik_net:
    external: true
