services:
  # Backend API Service
  searxng:
    image: searxng/searxng:latest
    container_name: wma-searxng
    volumes:
      - ./config/searxng:/etc/searxng:rw
    expose:
      - "8080"
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-q", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 3

  backend:
    image: ghcr.io/deepan-alve/win-my-argument-backend:latest
    container_name: wma-backend
    environment:
      - NODE_ENV=production
      - SEARXNG_API_URL=http://wma-searxng:8080
    depends_on:
      - searxng
    volumes:
      - backend-data:/home/perplexica/data
      - uploads-data:/home/perplexica/uploads
      - ./config/perplexica:/home/perplexica
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-q", "http://localhost:3001/api/models"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  frontend:
    image: ghcr.io/deepan-alve/win-my-argument-frontend:latest
    container_name: wma-frontend
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:3001/api}
      - NEXT_PUBLIC_WS_URL=${NEXT_PUBLIC_WS_URL:-ws://localhost:3001}
    depends_on:
      - backend
    networks:
      - traefik_net
      - default
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-q", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      # Traefik - HTTPS routes
      - "traefik.enable=true"
      - "traefik.http.routers.wma-https.rule=Host(`wma.deepanalve.dev`)" # CHANGE THIS
      - "traefik.http.routers.wma-https.entrypoints=websecure"
      - "traefik.http.routers.wma-https.service=frontend"
      - "traefik.http.routers.wma-https.middlewares=anubis@docker"

      # Service configuration
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"
      - "traefik.docker.network=traefik_net"

      # Watchtower
      - "com.centurylinklabs.watchtower.enable=true"

  # AutoKuma monitoring (optional)
  autokuma:
    image: busybox:latest
    container_name: wma-autokuma
    restart: always
    command: ["sleep", "infinity"]
    healthcheck:
      test: ["CMD", "sleep", "0"]
    labels:
      # AutoKuma (uptime-kuma) monitoring
      - "kuma.wma_grp.group.name=WMA"
      - 'kuma.wma_grp.group.notification_name_list=["ntfy"]'

      - "kuma.wma_http_1.http.name=WMA HTTP (wma.deepanalve.dev)"
      - "kuma.wma_http_1.http.url=https://wma.deepanalve.dev"
      - "kuma.wma_http_1.http.parent_name=wma_grp"

      - "kuma.wma_frontend.docker.name=WMA Frontend Container"
      - "kuma.wma_frontend.docker.docker_container=wma-frontend"
      - "kuma.wma_frontend.docker.docker_host_name=local"
      - "kuma.wma_frontend.docker.parent_name=wma_grp"

      - "kuma.wma_backend.docker.name=WMA Backend Container"
      - "kuma.wma_backend.docker.docker_container=wma-backend"
      - "kuma.wma_backend.docker.docker_host_name=local"
      - "kuma.wma_backend.docker.parent_name=wma_grp"

      - "kuma.wma_searxng.docker.name=WMA Searxng Container"
      - "kuma.wma_searxng.docker.docker_container=wma-searxng"
      - "kuma.wma_searxng.docker.docker_host_name=local"
      - "kuma.wma_searxng.docker.parent_name=wma_grp"

      # Watchtower
      - "com.centurylinklabs.watchtower.enable=true"

volumes:
  backend-data:
    driver: local
  uploads-data:
    driver: local

networks:
  traefik_net:
    external: true
