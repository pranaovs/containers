services:
  uptimekuma:
    image: louislam/uptime-kuma:2
    container_name: uptimekuma
    user: root
    restart: always
    ports:
      - "30090:3001"
    security_opt:
      - label=type:spc_t
    volumes:
      - /run/user/1000/podman/podman.sock:/var/run/docker.sock:ro
      - ./data/uptime_kuma:/app/data:Z,U
    labels:
      # Traefik
      - "traefik.enable=true"
      - "traefik.http.routers.uptimekuma-https.rule=Host(`status.pranaovs.me`) || Host(`uptime.pranaovs.me`)"
      - "traefik.http.routers.uptimekuma-https.entrypoints=websecure"
      - "traefik.http.routers.uptimekuma-https.service=uptimekuma"

      - "traefik.http.routers.uptimekuma-ts.rule=Host(`status.devserver.ts.net`) || Host(`uptime.devserver.ts.net`) || Host(`status.devserver`) || Host(`uptime.devserver`)"
      - "headnscale.subdomain=status|uptime"
      - "traefik.http.routers.uptimekuma-ts.entrypoints=web"
      - "traefik.http.routers.uptimekuma-ts.service=uptimekuma"

      - "traefik.http.services.uptimekuma.loadbalancer.server.port=3001"
      - "traefik.docker.network=traefik_net"
      # Watchtower
      - "com.centurylinklabs.watchtower.enable=true"
      # Podman Auto-Update
      - "io.containers.autoupdate=registry"
    networks:
      - default
      - traefik_net

  autokuma:
    image: ghcr.io/bigboot/autokuma:latest
    restart: always
    container_name: autokuma
    environment:
      AUTOKUMA__KUMA__URL: http://uptimekuma:3001
      # Default settings
      AUTOKUMA__DEFAULT_SETTINGS: |-
        *.max_retries: 5
    env_file: ".env"
    security_opt:
      - label=type:spc_t
    volumes:
      - /run/user/1000/podman/podman.sock:/var/run/docker.sock:ro
      - ./data/autokuma:/data:Z,U
    depends_on:
      - uptimekuma

    labels:
      # Docker setup
      - "kuma.local.docker_host.name=Docker socket"
      - "kuma.local.docker_host.connection_type=socket"
      - "kuma.local.docker_host.path=/var/run/docker.sock"
      # Notifications
      - kuma.ntfy.notification.name=ntfy Notifications
      - kuma.ntfy.notification.active=true
      - kuma.ntfy.notification.config={"isDefault":false,"name":"ntfy","ntfyAuthenticationMethod":"accessToken","ntfyPriority":5,"ntfyPriorityDown":5,"ntfyaccesstoken":"${AUTOKUMA_NTFY_ACCESS_TOKEN}","ntfyserverurl":"http://ntfy","ntfytopic":"${AUTOKUMA_NTFY_TOPIC}","type":"ntfy"}
      # Group for CTF Tools
      - "kuma.ctf_grp.group.name=CTF"

  autokuma-labels:
    image: busybox:latest
    container_name: uptimekuma-autokuma
    restart: always
    command: ["sleep", "infinity"]
    healthcheck:
      test: ["CMD", "sleep", "0"]
    labels:
      # AutoKuma (uptime-kuma)
      - "kuma.uptime_kuma_grp.group.name=Uptime Kuma"
      - 'kuma.uptime_kuma_grp.group.notification_name_list=["ntfy"]'
      - "kuma.uptime_kuma_http_1.http.name=Uptime Kuma (status.pranaovs.me)"
      - "kuma.uptime_kuma_http_1.http.url=https://status.pranaovs.me"
      - "kuma.uptime_kuma_http_1.http.parent_name=uptime_kuma_grp"
      - "kuma.uptime_kuma_http_2.http.name=Uptime Kuma (uptime.pranaovs.me)"
      - "kuma.uptime_kuma_http_2.http.url=https://uptime.pranaovs.me"
      - "kuma.uptime_kuma_http_2.http.parent_name=uptime_kuma_grp"
      - "kuma.uptime_kuma_container.docker.name=Uptime Kuma Container"
      - "kuma.uptime_kuma_container.docker.docker_container=uptimekuma"
      - "kuma.uptime_kuma_container.docker.docker_host_name=local"
      - "kuma.uptime_kuma_container.docker.parent_name=uptime_kuma_grp"

      - "kuma.autokuma_container.docker.name=AutoKuma Container"
      - "kuma.autokuma_container.docker.docker_container=autokuma"
      - "kuma.autokuma_container.docker.docker_host_name=local"
      - "kuma.autokuma_container.docker.parent_name=uptime_kuma_grp"

      # DNS Monitor
      - "kuma.dns_grp.group.name=DNS"
      - 'kuma.dns_grp.group.notification_name_list=["ntfy"]'
      - "kuma.dns_a.dns.name=pranaovs.me A"
      - "kuma.dns_a.dns.hostname=pranaovs.me"
      - "kuma.dns_a.dns.parent_name=dns_grp"
      - "kuma.dns_a.dns.dns_resolve_type=A"
      - "kuma.dns_aaaa.dns.name=pranaovs.me AAAA"
      - "kuma.dns_aaaa.dns.hostname=pranaovs.me"
      - "kuma.dns_aaaa.dns.dns_resolve_type=AAAA"
      - "kuma.dns_aaaa.dns.parent_name=dns_grp"
      # Watchtower
      - "com.centurylinklabs.watchtower.enable=true"
      # Podman Auto-Update
      - "io.containers.autoupdate=registry"

networks:
  traefik_net:
    external: true
